<%@ taglib prefix="s" uri="/struts-tags"%><s:url action="ajSearchMenu" namespace="/search" id="ajSearchMenuURL"/><s:url action="saveUserMenu" namespace="/permission" id="saveUserMenuURL"/><s:url action="index" namespace="/search" id="searchIndexURL"/><s:url action="saveEvent" namespace="/event" id="saveEventURL"/><s:url action="removeEvent" namespace="/event" id="removeEventURL"/><s:url action="getNhanvienByEvent" namespace="/ajax" id="getNhanvienByEventURL"/><style>select.multiple {width:265px;height:300px;}#msg p {  padding: 3px;}.td_label {width:100px;}</style><div id="msg" style="margin-bottom: 5px;"></div><form id="formSukien" onsubmit="return false"><input type="text" style="display:none" name="event.id" value="<s:property value='event.id' />"/><input type="text" style="display:none" name="event.ngaysukien" id="ngaysukien" value=""/><table style="width:100%">	<tr>		<td class="td_label">Tên sự kiện :</td>		<td><input class="field" style="width:500px" type="text" name="event.tensukien" id="tensukien" value="<s:property value='event.tensukien' />"/></td>	</tr>	<tr>		<td class="td_label" valign="top">Người nhận :</td>		<td>		<div id="users">		</div>		<span id="btThemnguoinhan" class="link" style="display: block; text-align: right;">Thêm người nhận</span>		</td>	</tr>	<tr>		<td class="td_label">Loại sự kiện</td>		<td>			<select id="loaisukien" name="event.loaisukienId" class="field size1">					<option data-ref="" value="" >--SELECT--</option>				<s:iterator value="loaisukiens">					<option data-ref='<s:property value="text" />' value="<s:property value='id' />"><s:property value="tenloaisukien" /></option>													</s:iterator>			</select>		</td>	</tr>	<tr>		<td class="td_label">Nội dung :</td>		<td><textarea spellcheck="false" name="event.noidung" id="noidung" style="width:500px" rows="3"><s:property value='event.noidung' /></textarea></td>	</tr>	<tr>		<td class="td_label">Loại thông báo</td>		<td>			<select id="loaithongbao" name="event.loaithongbao" class="field">					<option value="0" >Một lần</option>				<option value="1" >Hàng tuần</option>				<option value="2" >Hàng tháng</option>				<option value="3" >Hàng năm</option>			</select>		</td>	</tr>	<tr>		<td class="td_label"></td>		<td>Gửi thông báo cho tôi trước <input class="field" type="text" name="event.sendBefore" style="width: 20px; text-align: center;" value="<s:property value='event.sendBefore' />"/> ngày </td>	</tr>	<tr>		<td class="td_label"></td>		<td><button id="btSave">Lưu</button><button id="btRemove" style="margin-left:10px">Xóa</button><button id="btClose" style="margin-left:10px">Đóng</button></td>	</tr></table></form><script>var add_edit_event = {	dialog : null,	event_id : null,	init : function(init_data){		if(init_data.date_selected == "") {			alert("ERROR");			this.dialog.dialog("close");			return;		}		this.event_id = init_data.event_id;		$("#users").text("Loading...");		$.get("${getNhanvienByEventURL}",function(response){			var users = $("#users");			users.empty();			$.each(response.data,function(){				var data = {					id : this.msnhanvien,					ten_nhan_vien : this.honhanvien + " " + this.tennhanvien				}				users.append(new EJS({url: baseUrl + "/templates/events/template01.ejs"}).render(data));			});		});		$("#formSukien #ngaysukien").val(init_data.date_selected);		$("#formSukien #loaisukien").val("<s:property value='event.loaisukienId' />");		$("#formSukien #loaithongbao").val("<s:property value='event.loaithongbao' />");		this.dialog = $("#formSukien").parents(".ui-dialog-content");		this.dialog.dialog("option", "position", "center");		byId("tensukien").focus();		$("#formSukien #loaisukien").change(function(){			$("#formSukien #noidung").val($("option:selected",this).attr("data-ref"));		});		$("#btThemnguoinhan").click(function(){			showDialogUrl("${searchIndexURL}&type=2",'Chọn nhân viên cho sự kiện',610,$("#dialog1"));			return false;		});		$("#users").delegate(".user_selected a.remove","click",function(){			$(this).parents(".user_selected").remove();		});		$("#btSave").button({			icons: {				primary: "ui-icon-disk"			}		}).click(function(){			_this = this;			$(this).button({disabled:true});			var dataString = $("#formSukien").serialize();			$.ajax({				type: "POST",				cache: false,				url : "${saveEventURL}",				data : dataString,				success: function(data){					$(_this).button({disabled:null});					if(data == "END_SESSION") {						location.href = LOGIN_PATH;						return;					}					if(data == 'EMPTY_NHANVIEN') {						add_edit_event.message('Chưa chọn nhân viên cho sự kiện!',0);						return;					}					if(data == 'EMPTY_TENSUKIEN') {						add_edit_event.message('Chưa nhập tên sự kiện!',0);						byId("tensukien").focus();						return;					}					if(data == 'ERROR') {						add_edit_event.message('Có lỗi xảy ra, vui lòng thử lại!',0);						return;					}					if(data == 'OK') {						add_edit_event.message('Lưu thành công!',1);						refetchEvents();						return;					}					add_edit_event.message(data,0);				},				error: function(data){ alert (data);$(_this).button({disabled:null});}				});			return false;		})		$("#btRemove").button({			icons: {				primary: "ui-icon-trash"			}		}).click(function(){			if(!confirm("Bạn muốn xóa sự kiện này?")) {				return;			}			_this = this;			$(this).button({disabled:true});			$.ajax({				type: "GET",				cache: false,				url : "${removeEventURL}",				success: function(data){					$(_this).button({disabled:null});					if(data == "END_SESSION") {						location.href = LOGIN_PATH;						return;					}					if(data == 'ERROR') {						add_edit_event.message('Có lỗi xảy ra, vui lòng thử lại!',0);						return;					}					if(data == 'OK') {						refetchEvents();						add_edit_event.dialog.dialog("close");						return;					}					add_edit_event.message(data,0);				},				error: function(data){ alert (data);$(_this).button({disabled:null});}				});			return false;		})		$("#btClose").button({			icons: {				primary: "ui-icon-circle-close"			}		}).click(function(){			add_edit_event.dialog.dialog("close");			return false;		});		search_user_2.afterSelected = function(data){			var users = $("#users");			$.each(data,function(){				if($("#users #user_"+this.id).length > 0) return;				users.append(new EJS({url: baseUrl + "/templates/events/template01.ejs"}).render(this));			});		}	},	message : function(msg,type) {		if(msg == '') { // clear			$("#msg",this.dialog).empty();			return;		}		if(type==1) { //Thong diep thong bao			$("#msg",this.dialog).html('<div class="ui-state-highlight ui-corner-all" style=" padding: 0 .7em;"><p><span class="ui-icon ui-icon-info" style="float: left; margin-right: .3em;"></span><strong>Success : </strong> '+msg+'</p></div>');		} else if(type == 0) { //Thong diep bao loi			$("#msg",this.dialog).html('<div class="ui-state-error ui-corner-all" style="padding: 0 .7em;"><p><span class="ui-icon ui-icon-alert" style="float: left; margin-right: .3em;"></span><strong>Error : </strong> '+msg+'</p></div>');		}	},	}$(document).ready(function(){	add_edit_event.init({		date_selected : date_selected,		event_id : <s:property value='event.id' />	});});</script>